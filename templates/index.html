<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FitCoach AI - Your Personal Health & Fitness Assistant</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #10b981;
      --primary-dark: #059669;
      --secondary: #3b82f6;
      --accent: #f59e0b;
      --bg-light: #f0fdf4;
      --bg-dark: #1e3a2e;
      --text-dark: #064e3b;
      --text-light: #6b7280;
      --border: #d1fae5;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
      transition: background 0.3s ease;
    }

    body.dark-mode {
      --bg-light: #0f1e1a;
      --bg-dark: #0a1612;
      --text-dark: #d1fae5;
      --text-light: #9ca3af;
      --border: #1e3a2e;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100vh;
      max-width: 1800px;
      margin: 0 auto;
      background: var(--bg-light);
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    /* Sidebar */
    .sidebar {
      width: 300px;
      background: var(--bg-dark);
      padding: 20px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      margin-bottom: 20px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
      padding: 15px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 12px;
    }

    .logo-icon {
      font-size: 32px;
    }

    .logo-text h3 {
      color: #10b981;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .logo-text p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
    }

    .sidebar-search {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .sidebar-search:focus {
      outline: none;
      border-color: var(--primary);
    }

    .new-chat-btn {
      width: 100%;
      padding: 14px 20px;
      border: none;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .new-chat-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .quick-stats {
      background: rgba(16, 185, 129, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }

    .quick-stats h4 {
      color: #10b981;
      font-size: 14px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      color: rgba(255, 255, 255, 0.8);
      font-size: 13px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-value {
      color: #10b981;
      font-weight: 600;
    }

    #conversation-list {
      list-style: none;
      flex: 1;
      overflow-y: auto;
      margin-top: 15px;
      padding-right: 5px;
    }

    #conversation-list li {
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 10px;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.05);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
    }

    #conversation-list li:hover {
      background: rgba(16, 185, 129, 0.2);
      color: #fff;
      transform: translateX(5px);
    }

    #conversation-list li.active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    /* Chat Container */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #ffffff;
    }

    body.dark-mode .chat-container {
      background: var(--bg-light);
    }

    .chat-header {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 15px 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .chat-header h2 {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 12px;
      border-radius: 20px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #fff;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Quick Actions */
    .quick-actions {
      padding: 20px 30px;
      background: linear-gradient(to bottom, #ecfdf5, #f0fdf4);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 15px;
      overflow-x: auto;
    }

    body.dark-mode .quick-actions {
      background: linear-gradient(to bottom, #0a1612, #0f1e1a);
    }

    .action-card {
      min-width: 200px;
      padding: 15px 20px;
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    body.dark-mode .action-card {
      background: var(--bg-dark);
      border-color: rgba(16, 185, 129, 0.2);
    }

    .action-card:hover {
      border-color: var(--primary);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.2);
    }

    .action-icon {
      font-size: 28px;
    }

    .action-text h4 {
      color: var(--text-dark);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .action-text p {
      color: var(--text-light);
      font-size: 12px;
    }

    /* Suggested Prompts */
    .suggested-prompts {
      padding: 15px 30px;
      background: var(--bg-light);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      white-space: nowrap;
    }

    .prompt-chip {
      display: inline-block;
      padding: 10px 18px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 20px;
      margin-right: 10px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-dark);
      transition: all 0.2s;
    }

    body.dark-mode .prompt-chip {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    .prompt-chip:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    #chat-box {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      background: var(--bg-light);
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px;
    }

    .empty-state-icon {
      font-size: 100px;
      margin-bottom: 20px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .empty-state h3 {
      font-size: 28px;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .empty-state p {
      font-size: 16px;
      color: var(--text-light);
      max-width: 500px;
      line-height: 1.6;
    }

    /* Messages */
    .message {
      padding: 18px 22px;
      border-radius: 18px;
      max-width: 75%;
      word-wrap: break-word;
      line-height: 1.6;
      font-size: 15px;
      animation: slideIn 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      position: relative;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-timestamp {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 8px;
      display: block;
    }

    .message-actions {
      position: absolute;
      top: -35px;
      right: 10px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 5px;
      display: none;
      gap: 5px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    body.dark-mode .message-actions {
      background: var(--bg-dark);
    }

    .message:hover .message-actions {
      display: flex;
    }

    .message-actions button {
      background: transparent;
      border: none;
      color: var(--text-light);
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .message-actions button:hover {
      background: var(--bg-light);
      color: var(--primary);
    }

    .message.user {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      margin-left: auto;
    }

    .message.assistant {
      background: white;
      color: var(--text-dark);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      margin-right: auto;
      border: 1px solid var(--border);
    }

    body.dark-mode .message.assistant {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    /* Workout/Meal Plans */
    .plan-card {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
    }

    body.dark-mode .plan-card {
      background: linear-gradient(135deg, #0a1612 0%, #0f1e1a 100%);
    }

    .plan-card h4 {
      color: var(--primary);
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .plan-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(16, 185, 129, 0.2);
    }

    .plan-item:last-child {
      border-bottom: none;
    }

    /* Waiting State */
    .waiting {
      background: white !important;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      font-style: italic;
      color: var(--text-light);
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid var(--border);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Chat Input */
    .chat-input-container {
      padding: 20px 30px;
      background: white;
      border-top: 1px solid var(--border);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }

    body.dark-mode .chat-input-container {
      background: var(--bg-dark);
    }

    .input-wrapper {
      display: flex;
      gap: 12px;
      max-width: 1200px;
      margin: 0 auto;
      align-items: flex-end;
    }

    .input-actions {
      display: flex;
      gap: 8px;
    }

    .input-btn {
      background: var(--bg-light);
      border: 1px solid var(--border);
      color: var(--text-dark);
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      font-size: 20px;
    }

    .input-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .input-btn.recording {
      background: var(--error);
      color: white;
      animation: recordPulse 1s infinite;
    }

    @keyframes recordPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    #user-input {
      flex: 1;
      padding: 12px 20px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: var(--bg-light);
      color: var(--text-dark);
      resize: none;
      min-height: 44px;
      max-height: 150px;
      font-family: inherit;
    }

    body.dark-mode #user-input {
      background: var(--bg-light);
      color: var(--text-dark);
    }

    #user-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .send-btn {
      padding: 12px 24px;
      border: none;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-radius: 12px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      height: 44px;
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: modalSlide 0.3s ease;
    }

    body.dark-mode .modal-content {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    @keyframes modalSlide {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .modal-header h3 {
      font-size: 22px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--text-light);
      transition: all 0.2s;
    }

    .close-modal:hover {
      color: var(--error);
      transform: rotate(90deg);
    }

    .setting-item {
      margin-bottom: 20px;
    }

    .setting-item label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .setting-item select,
    .setting-item input[type="text"],
    .setting-item input[type="number"] {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--bg-light);
      color: var(--text-dark);
      font-size: 14px;
    }

    .setting-item select:focus,
    .setting-item input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .profile-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--primary);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 6px 30px rgba(0, 0, 0, 0.2);
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 2000;
      animation: slideUp 0.3s ease;
      min-width: 250px;
    }

    body.dark-mode .toast {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    .toast.active {
      display: flex;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--error);
    }

    .toast-icon {
      font-size: 24px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 250px;
        position: absolute;
        left: -250px;
        height: 100vh;
        z-index: 100;
      }

      .sidebar.active {
        transform: translateX(250px);
      }

      .message {
        max-width: 90%;
      }

      .quick-actions {
        gap: 10px;
      }

      .action-card {
        min-width: 160px;
      }

      .profile-section {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <span class="logo-icon">💪</span>
          <div class="logo-text">
            <h3>FitCoach AI</h3>
            <p>Your Health & Fitness Partner</p>
          </div>
        </div>

        <div class="quick-stats">
          <h4>📊 Quick Stats</h4>
          <div class="stat-item">
            <span>Sessions Today</span>
            <span class="stat-value" id="sessions-today">0</span>
          </div>
          <div class="stat-item">
            <span>Total Workouts</span>
            <span class="stat-value" id="total-workouts">0</span>
          </div>
          <div class="stat-item">
            <span>Streak</span>
            <span class="stat-value" id="streak-days">0 days</span>
          </div>
        </div>

        <input type="text" class="sidebar-search" id="search-conversations" placeholder="Search coaching sessions...">
        <button class="new-chat-btn" onclick="createNewConversation()">+ New Session</button>
      </div>
      <ul id="conversation-list"></ul>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-header-left">
          <h2 id="chat-title">💪 FitCoach AI</h2>
          <div class="status-indicator">
            <span class="status-dot"></span>
            <span>Ready to Train</span>
          </div>
        </div>
        <div class="header-actions">
          <button class="header-btn" onclick="toggleProfile()">👤 Profile</button>
          <button class="header-btn" onclick="toggleSettings()">⚙️ Settings</button>
          <button class="header-btn" onclick="exportPlan()">📥 Export Plan</button>
          <button class="header-btn" onclick="toggleTheme()">🌙</button>
        </div>
      </div>

      <div class="quick-actions">
        <div class="action-card" onclick="usePrompt('Create a workout plan for me')">
          <span class="action-icon">🏋️</span>
          <div class="action-text">
            <h4>Workout Plan</h4>
            <p>Personalized training</p>
          </div>
        </div>
        <div class="action-card" onclick="usePrompt('Design a meal plan for muscle gain')">
          <span class="action-icon">🥗</span>
          <div class="action-text">
            <h4>Meal Plan</h4>
            <p>Nutrition guidance</p>
          </div>
        </div>
        <div class="action-card" onclick="usePrompt('Track my progress and calories')">
          <span class="action-icon">📈</span>
          <div class="action-text">
            <h4>Track Progress</h4>
            <p>Monitor your goals</p>
          </div>
        </div>
        <div class="action-card" onclick="usePrompt('Give me recovery tips')">
          <span class="action-icon">🧘</span>
          <div class="action-text">
            <h4>Recovery</h4>
            <p>Rest & recovery</p>
          </div>
        </div>
        <div class="action-card" onclick="usePrompt('Analyze my form in this exercise')">
          <span class="action-icon">🎯</span>
          <div class="action-text">
            <h4>Form Check</h4>
            <p>Technique analysis</p>
          </div>
        </div>
      </div>

      <div class="suggested-prompts">
        <span class="prompt-chip" onclick="usePrompt('What exercises are best for losing belly fat?')">🔥 Lose belly fat</span>
        <span class="prompt-chip" onclick="usePrompt('Create a 30-day muscle building program')">💪 Build muscle</span>
        <span class="prompt-chip" onclick="usePrompt('How many calories should I eat per day?')">🍽️ Calorie needs</span>
        <span class="prompt-chip" onclick="usePrompt('What are good pre-workout meals?')">⚡ Pre-workout fuel</span>
        <span class="prompt-chip" onclick="usePrompt('Design a stretching routine for flexibility')">🤸 Flexibility routine</span>
        <span class="prompt-chip" onclick="usePrompt('How do I improve my running endurance?')">🏃 Improve endurance</span>
      </div>

      <div id="chat-box">
        <div class="empty-state">
          <div class="empty-state-icon">💪</div>
          <h3>Welcome to FitCoach AI!</h3>
          <p>Your personal health and sports coach powered by RAGflow. I'm here to help you with workout plans, nutrition advice, form checks, progress tracking, and achieving your fitness goals. Let's start your journey to a healthier you!</p>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="uploaded-files" id="uploaded-files"></div>
        <div class="input-wrapper">
          <div class="input-actions">
            <button class="input-btn" onclick="document.getElementById('file-input').click()" title="Upload progress photos or documents">📎</button>
            <button class="input-btn" id="voice-btn" onclick="toggleVoiceInput()" title="Voice input">🎤</button>
            <button class="input-btn" onclick="insertEmoji('💪')" title="Quick emoji">💪</button>
            <input type="file" id="file-input" style="display: none" multiple accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg">
          </div>
          <textarea
            id="user-input"
            placeholder="Ask about workouts, nutrition, or fitness goals..."
            onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
            rows="1"
          ></textarea>
          <button class="send-btn" onclick="sendMessage()">Send 🚀</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal" id="profile-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>👤 Your Fitness Profile</h3>
        <button class="close-modal" onclick="closeProfile()">×</button>
      </div>

      <div class="profile-section">
        <div class="setting-item">
          <label>Age</label>
          <input type="number" id="profile-age" placeholder="25" min="10" max="100">
        </div>

        <div class="setting-item">
          <label>Gender</label>
          <select id="profile-gender">
            <option value="">Select</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>

      <div class="profile-section">
        <div class="setting-item">
          <label>Height (cm)</label>
          <input type="number" id="profile-height" placeholder="175">
        </div>

        <div class="setting-item">
          <label>Weight (kg)</label>
          <input type="number" id="profile-weight" placeholder="70">
        </div>
      </div>

      <div class="setting-item">
        <label>Fitness Goal</label>
        <select id="profile-goal">
          <option value="">Select your goal</option>
          <option value="lose-weight">Lose Weight</option>
          <option value="build-muscle">Build Muscle</option>
          <option value="improve-endurance">Improve Endurance</option>
          <option value="increase-flexibility">Increase Flexibility</option>
          <option value="general-fitness">General Fitness</option>
          <option value="sports-performance">Sports Performance</option>
        </select>
      </div>

      <div class="setting-item">
        <label>Activity Level</label>
        <select id="profile-activity">
          <option value="">Select activity level</option>
          <option value="sedentary">Sedentary (little or no exercise)</option>
          <option value="light">Light (1-3 days/week)</option>
          <option value="moderate">Moderate (3-5 days/week)</option>
          <option value="active">Active (6-7 days/week)</option>
          <option value="very-active">Very Active (2x per day)</option>
        </select>
      </div>

      <div class="setting-item">
        <label>Dietary Preferences</label>
        <select id="profile-diet">
          <option value="">Select dietary preference</option>
          <option value="none">No restrictions</option>
          <option value="vegetarian">Vegetarian</option>
          <option value="vegan">Vegan</option>
          <option value="keto">Keto</option>
          <option value="paleo">Paleo</option>
          <option value="gluten-free">Gluten-Free</option>
        </select>
      </div>

      <div class="setting-item">
        <label>Medical Conditions / Injuries</label>
        <input type="text" id="profile-medical" placeholder="e.g., knee injury, diabetes, none">
      </div>

      <button class="new-chat-btn" style="margin-top: 10px;" onclick="saveProfile()">💾 Save Profile</button>
    </div>
  </div>

<!-- Settings Modal -->
<div class="modal" id="settings-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>⚙️ Settings</h3>
            <button class="close-modal" onclick="closeSettings()">×</button>
        </div>

        <div class="setting-item">
            <label>AI Coaching Style</label>
            <select id="coaching-style">
                <option value="motivational">Motivational & Encouraging</option>
                <option value="professional">Professional & Technical</option>
                <option value="casual">Casual & Friendly</option>
                <option value="strict">Strict & Disciplined</option>
            </select>
        </div>

        <div class="setting-item">
            <label>Response Detail Level</label>
            <select id="detail-level">
                <option value="brief">Brief (Quick answers)</option>
                <option value="moderate">Moderate (Balanced)</option>
                <option value="detailed">Detailed (In-depth)</option>
            </select>
        </div>

        <div class="setting-item">
            <label>Measurement Units</label>
            <select id="units">
                <option value="metric">Metric (kg, cm)</option>
                <option value="imperial">Imperial (lbs, inches)</option>
            </select>
        </div>

        <div class="setting-item">
            <label style="display: flex; justify-content: space-between; align-items: center;">
                <span>Dark Mode</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="dark-mode-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </label>
        </div>

        <div class="setting-item">
            <label style="display: flex; justify-content: space-between; align-items: center;">
                <span>Voice Responses</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="auto-speak-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </label>
        </div>

        <div class="setting-item">
            <label style="display: flex; justify-content: space-between; align-items: center;">
                <span>Daily Reminders</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="reminders-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </label>
        </div>

        <div class="setting-item">
            <label style="display: flex; justify-content: space-between; align-items: center;">
                <span>Show Calorie Estimates</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="calories-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </label>
        </div>

        <!-- Add Save Button -->
        <button class="new-chat-btn" style="margin-top: 20px; width: 100%;" onclick="saveSettings()">
            💾 Save Settings
        </button>
    </div>
</div>


  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span class="toast-icon" id="toast-icon"></span>
    <span id="toast-message"></span>
  </div>

  <script>
    let activeSessionId = null;
    let renamedOnce = false;
    let recognition = null;
    let uploadedFiles = [];
    let userProfile = {};

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
      loadSessions();
      loadProfile();
      loadStats();
      initializeVoiceRecognition();

      // Auto-resize textarea
      const textarea = document.getElementById('user-input');
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });

      // Search conversations
      document.getElementById('search-conversations').addEventListener('input', filterConversations);

      // File upload
      document.getElementById('file-input').addEventListener('change', handleFiles);
    });

    // Load user profile
    function loadProfile() {
      const saved = localStorage.getItem('fitcoach-profile');
      if (saved) {
        userProfile = JSON.parse(saved);
        document.getElementById('profile-age').value = userProfile.age || '';
        document.getElementById('profile-gender').value = userProfile.gender || '';
        document.getElementById('profile-height').value = userProfile.height || '';
        document.getElementById('profile-weight').value = userProfile.weight || '';
        document.getElementById('profile-goal').value = userProfile.goal || '';
        document.getElementById('profile-activity').value = userProfile.activity || '';
        document.getElementById('profile-diet').value = userProfile.diet || '';
        document.getElementById('profile-medical').value = userProfile.medical || '';
      }
    }

    // Load stats
    function loadStats() {
      const stats = JSON.parse(localStorage.getItem('fitcoach-stats') || '{"sessionsToday": 0, "totalWorkouts": 0, "streakDays": 0}');
      document.getElementById('sessions-today').textContent = stats.sessionsToday;
      document.getElementById('total-workouts').textContent = stats.totalWorkouts;
      document.getElementById('streak-days').textContent = stats.streakDays + ' days';
    }

    // Update stats
    function updateStats() {
      const stats = JSON.parse(localStorage.getItem('fitcoach-stats') || '{"sessionsToday": 0, "totalWorkouts": 0, "streakDays": 0}');
      stats.sessionsToday += 1;
      stats.totalWorkouts += 1;

      const lastSession = localStorage.getItem('last-session-date');
      const today = new Date().toDateString();

      if (lastSession === today) {
        // Same day, no change to streak
      } else if (lastSession === new Date(Date.now() - 86400000).toDateString()) {
        // Previous day, increment streak
        stats.streakDays += 1;
      } else {
        // Reset streak
        stats.streakDays = 1;
      }

      localStorage.setItem('last-session-date', today);
      localStorage.setItem('fitcoach-stats', JSON.stringify(stats));
      loadStats();
    }

    // Filter conversations
    function filterConversations() {
      const search = document.getElementById('search-conversations').value.toLowerCase();
      const conversations = document.querySelectorAll('#conversation-list li');

      conversations.forEach(conv => {
        const text = conv.textContent.toLowerCase();
        conv.style.display = text.includes(search) ? 'block' : 'none';
      });
    }

    // Load sessions
    async function loadSessions() {
      const res = await fetch("/sessions");
      const sessions = await res.json();

      const list = document.getElementById("conversation-list");
      list.innerHTML = "";

      if (sessions.error) {
        console.error("Error fetching sessions:", sessions.error);
        return;
      }

      sessions.forEach(s => {
        const li = document.createElement("li");
        li.textContent = s.name || `Session ${s.id.slice(0, 6)}`;
        li.onclick = async () => {
          await activateSession(s.id);
        };

        if (s.id === activeSessionId) {
          li.classList.add("active");
        }

        list.appendChild(li);
      });
    }

// Fix the createNewConversation function
async function createNewConversation() {
    try {
        // Create a more descriptive default name
        const defaultName = `Workout Session ${new Date().toLocaleDateString()}`;

        const res = await fetch("/sessions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                name: defaultName
            })
        });

        const session = await res.json();

        if (session.error) {
            showToast("❌ Error creating session: " + session.error, "error");
            return;
        }

        await loadSessions();
        await activateSession(session.id);
        showToast("✅ New coaching session started!", "success");
        updateStats();

    } catch (error) {
        console.error("Error creating session:", error);
        showToast("❌ Error creating session", "error");
    }
}
    // Activate session
    // Activate session
    async function activateSession(id) {
      try {
        // 1. Activate the session on the backend
        await fetch(`/sessions/${id}/activate`, { method: "POST" });
        activeSessionId = id;

        // 2. Fetch the session's messages and name
        const msgRes = await fetch(`/sessions/${id}/messages`);
        const messagesData = await msgRes.json();

        if (messagesData.error) {
          console.error("Error fetching messages:", messagesData.error);
          showToast(messagesData.error, "error");
          return;
        }

        // 3. Update the chat title
        document.getElementById("chat-title").textContent =
          "💪 " + (messagesData.session_name || "FitCoach AI");

        // 4. Get the messages array safely
        const messages = messagesData.messages || [];
        renamedOnce = messages.length > 0;

        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML = "";

        // 5. Display messages or the empty state
        if (messages.length === 0) {
          chatBox.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">💪</div>
              <h3>Welcome to FitCoach AI!</h3>
              <p>Your personal health and sports coach powered by RAGflow. I'm here to help you with workout plans, nutrition advice, form checks, progress tracking, and achieving your fitness goals. Let's start your journey to a healthier you!</p>
            </div>
          `;
        } else {
          messages.forEach(m => {
            if (m && m.content) {
              displayMessage(m.content, m.role === "user" ? "user" : "assistant");
            }
          });
        }

        chatBox.scrollTop = chatBox.scrollHeight;

        // 6. Refresh the session list to highlight the active one
        await loadSessions();

      } catch (err) {
        console.error("Failed to activate session:", err);
        showToast("Could not switch conversations.", "error");
      }
    }

function displayMessage(content, role) {
  const chatBox = document.getElementById("chat-box");

  // Remove empty state if exists
  const emptyState = chatBox.querySelector('.empty-state');
  if (emptyState) {
    emptyState.remove();
  }

  const div = document.createElement("div");
  div.classList.add("message", role);

  const now = new Date();
  const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

  // Convert content to string safely
  let messageContent;
  if (typeof content === 'string') {
    messageContent = content;
  } else if (typeof content === 'object' && content !== null) {
    // Try to extract text from common object properties
    messageContent = content.message || content.text || content.content || content.response || JSON.stringify(content);
  } else {
    messageContent = String(content);
  }

  div.innerHTML = `
    <div class="message-content-wrapper">
      ${marked.parse(messageContent)}
    </div>
    <span class="message-timestamp">${time}</span>
    <div class="message-actions">
      <button onclick="copyMessage(this)" title="Copy">📋</button>
      <button onclick="speakMessage(this)" title="Speak">🔊</button>
      ${role === 'assistant' ? '<button onclick="regenerateMessage(this)" title="Regenerate">🔄</button>' : ''}
    </div>
  `;

  chatBox.appendChild(div);

  // Highlight code blocks if present
  div.querySelectorAll('pre code').forEach((block) => {
    if (typeof hljs !== 'undefined') {
      hljs.highlightElement(block);
    }
  });

  chatBox.scrollTop = chatBox.scrollHeight;
  return div;
}
    // Copy message
    function copyMessage(btn) {
      const message = btn.closest('.message');
      const text = message.textContent.replace(/📋🔊🔄\d{1,2}:\d{2}\s[AP]M/g, '').trim();
      navigator.clipboard.writeText(text);
      showToast("📋 Message copied!", "success");
    }

    // Speak message
    function speakMessage(btn) {
      const message = btn.closest('.message');
      const text = message.textContent.replace(/📋🔊🔄\d{1,2}:\d{2}\s[AP]M/g, '').trim();

      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        speechSynthesis.speak(utterance);
        showToast("🔊 Speaking...", "success");
      } else {
        showToast("❌ Speech not supported", "error");
      }
    }

    // Regenerate message
    async function regenerateMessage(btn) {
      const message = btn.closest('.message');
      const prevMessage = message.previousElementSibling;

      if (prevMessage && prevMessage.classList.contains('user')) {
        const userText = prevMessage.textContent.replace(/📋🔊🔄\d{1,2}:\d{2}\s[AP]M/g, '').trim();
        message.remove();
        await sendMessageWithText(userText);
      }
    }

    // Rename session
    async function renameSession(sessionId, newName) {
      try {
        const res = await fetch(`/sessions/${sessionId}/rename`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: newName })
        });

        const responseText = await res.text();

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${responseText}`);
        }

        const updated = JSON.parse(responseText);

        if (updated.error) {
          throw new Error(updated.error);
        }

        document.getElementById("chat-title").textContent = "💪 " + updated.name;
        await loadSessions();
        return true;

      } catch (err) {
        console.error("Rename error:", err);
        return false;
      }
    }

    // Send message
    async function sendMessage() {
      const input = document.getElementById("user-input");
      const text = input.value.trim();
      if (!text || !activeSessionId) {
        if (!activeSessionId) {
          showToast("⚠️ Please start a new session first", "error");
        }
        return;
      }

      await sendMessageWithText(text);
      input.value = "";
      input.style.height = 'auto';
    }

    async function sendMessageWithText(text) {
  const chatBox = document.getElementById("chat-box");
  const isFirstMessage = !renamedOnce;

  displayMessage(text, "user");

  const spinnerDiv = document.createElement("div");
  spinnerDiv.classList.add("message", "assistant", "waiting");
  spinnerDiv.innerHTML = `
    <span>Analyzing your request...</span>
    <div class="spinner"></div>
  `;
  chatBox.appendChild(spinnerDiv);
  chatBox.scrollTop = chatBox.scrollHeight;

  try {
    const eventSource = new EventSource(`/ask?question=${encodeURIComponent(text)}`);
    let fullText = "";
    let aiDiv = null;

    eventSource.onmessage = (event) => {
      if (event.data === "\"END\"" || event.data === "END") {
        eventSource.close();

        // Auto-speak if enabled
        if (document.getElementById('auto-speak-toggle')?.checked) {
          const utterance = new SpeechSynthesisUtterance(fullText);
          speechSynthesis.speak(utterance);
        }

        // Save message and handle first message renaming
        setTimeout(async () => {
          try {
            const checkRes = await fetch(`/sessions/${activeSessionId}/check`);
            const checkData = await checkRes.json();

            if (checkData.message_count === 0) {
              await fetch(`/sessions/${activeSessionId}/save_message`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  user_message: text,
                  assistant_message: fullText
                })
              });
            }
          } catch (err) {
            console.error("Error checking/saving messages:", err);
          }
        }, 1000);

        if (isFirstMessage && !renamedOnce) {
          renamedOnce = true;
          const newName = text.length > 30 ? text.slice(0, 30) + "…" : text;
          setTimeout(async () => {
            await renameSession(activeSessionId, newName);
          }, 1500);
        }
        return;
      }

      try {
        let data = event.data;

        // Try to parse JSON, but if it fails, use the raw data
        try {
          const parsed = JSON.parse(data);
          data = parsed;
        } catch (e) {
          // If it's not JSON, keep it as string
        }

        // Handle the data whether it's string or object
        if (typeof data === 'string') {
          fullText += data;
        } else if (typeof data === 'object') {
          // Extract text from object
          const textFromObject = data.message || data.text || data.content || data.response || JSON.stringify(data);
          fullText += textFromObject;
        }

        if (!aiDiv) {
          chatBox.removeChild(spinnerDiv);
          aiDiv = displayMessage(fullText, "assistant");
        } else {
          const now = new Date();
          const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

          aiDiv.innerHTML = `
            ${marked.parse(fullText)}
            <span class="message-timestamp">${time}</span>
            <div class="message-actions">
              <button onclick="copyMessage(this)" title="Copy">📋</button>
              <button onclick="speakMessage(this)" title="Speak">🔊</button>
              <button onclick="regenerateMessage(this)" title="Regenerate">🔄</button>
            </div>
          `;
        }

        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (err) {
        console.error("Error processing response:", err);
      }
    };

    eventSource.onerror = (err) => {
      console.error("EventSource error:", err);
      eventSource.close();

      if (!aiDiv) {
        chatBox.removeChild(spinnerDiv);
        displayMessage("⚠️ Error generating response. Please try again.", "assistant");
      }

      if (isFirstMessage && !renamedOnce) {
        renamedOnce = true;
        const newName = text.length > 30 ? text.slice(0, 30) + "…" : text;
        setTimeout(async () => {
          await renameSession(activeSessionId, newName);
        }, 1000);
      }
    };

  } catch (error) {
    console.error("Error creating EventSource:", error);
    chatBox.removeChild(spinnerDiv);
    displayMessage("⚠️ Error connecting to AI service. Please try again.", "assistant");
  }
}

    // Use suggested prompt
    function usePrompt(text) {
      document.getElementById('user-input').value = text;
      document.getElementById('user-input').focus();
    }

    // Insert emoji
    function insertEmoji(emoji) {
      const input = document.getElementById('user-input');
      input.value += emoji;
      input.focus();
    }

    // Theme toggle
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      document.getElementById('dark-mode-toggle').checked = isDark;
      localStorage.setItem('darkMode', isDark);
    }

    // Load saved theme
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
      document.getElementById('dark-mode-toggle').checked = true;
    }

    // Modals
    function toggleProfile() {
      document.getElementById('profile-modal').classList.add('active');
    }

    function closeProfile() {
      document.getElementById('profile-modal').classList.remove('active');
    }

    function toggleSettings() {
      document.getElementById('settings-modal').classList.add('active');
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.remove('active');
    }

    // Export plan
    async function exportPlan() {
      if (!activeSessionId) {
        showToast("⚠️ No active session to export", "error");
        return;
      }

      const msgRes = await fetch(`/sessions/${activeSessionId}/messages`);
      const messages = await msgRes.json();

      let markdown = `# FitCoach AI - Training Session Export\n\n`;
      markdown += `**Date:** ${new Date().toLocaleDateString()}\n\n`;

      if (userProfile.goal) {
        markdown += `**Goal:** ${userProfile.goal}\n`;
      }
      if (userProfile.activity) {
        markdown += `**Activity Level:** ${userProfile.activity}\n`;
      }
      markdown += `\n---\n\n`;

      messages.forEach(m => {
        markdown += `## ${m.role === 'user' ? '👤 You' : '💪 Coach'}\n${m.content}\n\n`;
      });

      const blob = new Blob([markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `fitcoach-plan-${new Date().toISOString().split('T')[0]}.md`;
      a.click();

      showToast("📥 Training plan exported!", "success");
    }




// Load settings
async function loadSettings() {
    try {
        const res = await fetch("/settings");
        const settings = await res.json();

        if (settings && !settings.error) {
            userSettings = { ...userSettings, ...settings };
        } else {
            // Load from localStorage as fallback
            const saved = localStorage.getItem('fitcoach-settings');
            if (saved) {
                userSettings = { ...userSettings, ...JSON.parse(saved) };
            }
        }

        applySettingsToUI();
        console.log("✅ Settings loaded:", userSettings);

    } catch (error) {
        console.error("Error loading settings:", error);
        // Load from localStorage as fallback
        const saved = localStorage.getItem('fitcoach-settings');
        if (saved) {
            userSettings = { ...userSettings, ...JSON.parse(saved) };
            applySettingsToUI();
        }
    }
}

// Apply settings that have immediate effects
function applySettingsImmediately() {
    // Dark mode
    if (userSettings.dark_mode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }

    // Update UI based on units
    updateUnitsDisplay();

    console.log("🔧 Settings applied:", userSettings);
}


// Convert units for display (you can expand this as needed)
function convertUnits(value, fromUnit, toUnit) {
    if (fromUnit === toUnit) return value;

    if (fromUnit === 'cm' && toUnit === 'inches') {
        return (value / 2.54).toFixed(1);
    } else if (fromUnit === 'inches' && toUnit === 'cm') {
        return (value * 2.54).toFixed(1);
    } else if (fromUnit === 'kg' && toUnit === 'lbs') {
        return (value * 2.20462).toFixed(1);
    } else if (fromUnit === 'lbs' && toUnit === 'kg') {
        return (value / 2.20462).toFixed(1);
    }

    return value;
}

// Update the profile saving to handle units
async function saveProfile() {
    const profileData = {
        age: document.getElementById('profile-age').value,
        gender: document.getElementById('profile-gender').value,
        height: document.getElementById('profile-height').value,
        weight: document.getElementById('profile-weight').value,
        goal: document.getElementById('profile-goal').value,
        activity: document.getElementById('profile-activity').value,
        diet: document.getElementById('profile-diet').value,
        medical: document.getElementById('profile-medical').value
    };

    // Show loading state
    const saveBtn = document.querySelector('.new-chat-btn');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = '💾 Updating AI Assistant...';
    saveBtn.disabled = true;

    try {
        // Send profile to backend to update RAGFlow assistant
        const res = await fetch("/profile", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(profileData)
        });

        const result = await res.json();

        if (result.success) {
            // Also save to localStorage so we can repopulate the form later
            localStorage.setItem('fitcoach-profile', JSON.stringify(profileData));
            userProfile = profileData;

            closeProfile();
            showToast('💪 ' + result.message, 'success');
        } else {
            showToast('❌ ' + (result.error || 'Failed to update profile'), 'error');
        }
    } catch (error) {
        console.error('Error saving profile:', error);
        showToast('❌ Network error saving profile', 'error');
    } finally {
        // Restore button state
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    }
}

// Update settings modal to include save button
// Add this to your settings modal HTML (replace the current content):
function updateSettingsModal() {
    const settingsModal = document.getElementById('settings-modal');
    settingsModal.querySelector('.modal-content').innerHTML += `
        <button class="new-chat-btn" style="margin-top: 20px; width: 100%;" onclick="saveSettings()">
            💾 Save Settings
        </button>
    `;
}

// Settings management
let userSettings = {
    coaching_style: 'motivational',
    detail_level: 'moderate',
    units: 'metric',
    dark_mode: false,
    auto_speak: false,
    reminders: false,
    show_calories: true
};


// Load both settings and profile
async function loadUserData() {
    try {
        const res = await fetch("/user-data");
        const data = await res.json();

        if (data && !data.error) {
            if (data.profile) {
                userProfile = data.profile;
                applyProfileToForm();
            }
            if (data.settings) {
                userSettings = { ...userSettings, ...data.settings };
                applySettingsToUI();
            }
        } else {
            // Fallback to localStorage
            await loadFromLocalStorage();
        }

        console.log("✅ User data loaded:", { profile: userProfile, settings: userSettings });

    } catch (error) {
        console.error("Error loading user data:", error);
        // Fallback to localStorage
        await loadFromLocalStorage();
    }
}

// Load from localStorage as fallback
async function loadFromLocalStorage() {
    const savedProfile = localStorage.getItem('fitcoach-profile');
    const savedSettings = localStorage.getItem('fitcoach-settings');

    if (savedProfile) {
        userProfile = JSON.parse(savedProfile);
        applyProfileToForm();
    }
    if (savedSettings) {
        userSettings = { ...userSettings, ...JSON.parse(savedSettings) };
        applySettingsToUI();
    }
}

// Apply profile data to form
function applyProfileToForm() {
    document.getElementById('profile-age').value = userProfile.age || '';
    document.getElementById('profile-gender').value = userProfile.gender || '';
    document.getElementById('profile-height').value = userProfile.height || '';
    document.getElementById('profile-weight').value = userProfile.weight || '';
    document.getElementById('profile-goal').value = userProfile.goal || '';
    document.getElementById('profile-activity').value = userProfile.activity || '';
    document.getElementById('profile-diet').value = userProfile.diet || '';
    document.getElementById('profile-medical').value = userProfile.medical || '';
}

// Save settings
async function saveSettings() {
    try {
        // Get current values from UI
        userSettings.coaching_style = document.getElementById('coaching-style').value;
        userSettings.detail_level = document.getElementById('detail-level').value;
        userSettings.units = document.getElementById('units').value;
        userSettings.dark_mode = document.getElementById('dark-mode-toggle').checked;
        userSettings.auto_speak = document.getElementById('auto-speak-toggle').checked;
        userSettings.reminders = document.getElementById('reminders-toggle').checked;
        userSettings.show_calories = document.getElementById('calories-toggle').checked;

        // Save to backend
        const res = await fetch("/settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                ...userSettings,
                profile_data: userProfile  // Include profile data in the request
            })
        });

        const result = await res.json();

        if (result.success) {
            // Also save to localStorage as backup
            localStorage.setItem('fitcoach-settings', JSON.stringify(userSettings));
            closeSettings();
            showToast('⚙️ ' + result.message, 'success');

            // Apply immediate UI changes
            applySettingsImmediately();

        } else {
            showToast('❌ ' + (result.error || 'Failed to save settings'), 'error');
        }
    } catch (error) {
        console.error('Error saving settings:', error);
        showToast('❌ Network error saving settings', 'error');
    }
}


// Apply settings to UI elements
function applySettingsToUI() {
    // Set dropdown values
    if (document.getElementById('coaching-style')) {
        document.getElementById('coaching-style').value = userSettings.coaching_style;
    }
    if (document.getElementById('detail-level')) {
        document.getElementById('detail-level').value = userSettings.detail_level;
    }
    if (document.getElementById('units')) {
        document.getElementById('units').value = userSettings.units;
    }

    // Set toggle states
    if (document.getElementById('dark-mode-toggle')) {
        document.getElementById('dark-mode-toggle').checked = userSettings.dark_mode;
    }
    if (document.getElementById('auto-speak-toggle')) {
        document.getElementById('auto-speak-toggle').checked = userSettings.auto_speak;
    }
    if (document.getElementById('reminders-toggle')) {
        document.getElementById('reminders-toggle').checked = userSettings.reminders;
    }
    if (document.getElementById('calories-toggle')) {
        document.getElementById('calories-toggle').checked = userSettings.show_calories;
    }

    // Apply immediate effects
    applySettingsImmediately();
}

// Update display based on units
function updateUnitsDisplay() {
    const units = userSettings.units;

    // Update profile form labels
    const heightLabel = document.querySelector('label[for="profile-height"]');
    const weightLabel = document.querySelector('label[for="profile-weight"]');

    if (heightLabel) {
        heightLabel.textContent = `Height (${units === 'metric' ? 'cm' : 'inches'})`;
    }
    if (weightLabel) {
        weightLabel.textContent = `Weight (${units === 'metric' ? 'kg' : 'lbs'})`;
    }
}

// Update the initialization
document.addEventListener("DOMContentLoaded", () => {
    loadSessions();
    loadUserData(); // Replace loadProfile() and loadSettings() with this
    loadStats();
    initializeVoiceRecognition();

    // Auto-resize textarea
    const textarea = document.getElementById('user-input');
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });

    // Search conversations
    document.getElementById('search-conversations').addEventListener('input', filterConversations);

    // File upload
    document.getElementById('file-input').addEventListener('change', handleFiles);
});

// Initialize settings when page loads
document.addEventListener("DOMContentLoaded", () => {
    loadSessions();
    loadProfile();
    loadSettings(); // Add this line
    loadStats();
    initializeVoiceRecognition();

    // Auto-resize textarea
    const textarea = document.getElementById('user-input');
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });

    // Search conversations
    document.getElementById('search-conversations').addEventListener('input', filterConversations);

    // File upload
    document.getElementById('file-input').addEventListener('change', handleFiles);
});

    // File upload
    function handleFiles(e) {
      const files = Array.from(e.target.files);
      const filesContainer = document.getElementById('uploaded-files');

      files.forEach(file => {
        uploadedFiles.push(file);

        const chip = document.createElement('div');
        chip.className = 'file-chip';
        chip.style.cssText = `
          display: inline-flex;
          align-items: center;
          gap: 8px;
          background: var(--bg-light);
          border: 1px solid var(--border);
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 13px;
          margin-right: 8px;
          margin-bottom: 8px;
        `;
        chip.innerHTML = `
          📎 ${file.name}
          <button onclick="removeFile('${file.name}')" style="background: none; border: none; color: var(--error); cursor: pointer; font-weight: bold;">×</button>
        `;
        filesContainer.appendChild(chip);
      });

      showToast(`📎 ${files.length} file(s) attached`, "success");
    }

    function removeFile(fileName) {
      uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
      const filesContainer = document.getElementById('uploaded-files');
      const chips = Array.from(filesContainer.children);
      chips.forEach(chip => {
        if (chip.textContent.includes(fileName)) {
          chip.remove();
        }
      });
    }

    // Voice recognition
    function initializeVoiceRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          document.getElementById('user-input').value = transcript;
          document.getElementById('voice-btn').classList.remove('recording');
        };

        recognition.onerror = () => {
          document.getElementById('voice-btn').classList.remove('recording');
          showToast("❌ Voice recognition error", "error");
        };

        recognition.onend = () => {
          document.getElementById('voice-btn').classList.remove('recording');
        };
      }
    }

    function toggleVoiceInput() {
      if (!recognition) {
        showToast("❌ Voice input not supported", "error");
        return;
      }

      const voiceBtn = document.getElementById('voice-btn');

      if (voiceBtn.classList.contains('recording')) {
        recognition.stop();
        voiceBtn.classList.remove('recording');
      } else {
        recognition.start();
        voiceBtn.classList.add('recording');
        showToast("🎤 Listening...", "success");
      }
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      const toastIcon = document.getElementById('toast-icon');

      toastIcon.textContent = type === 'success' ? '✅' : '❌';
      toastMessage.textContent = message;
      toast.className = `toast ${type} active`;

      setTimeout(() => {
        toast.classList.remove('active');
      }, 3000);
    }

    // Click outside modal to close
    window.onclick = function(event) {
      const settingsModal = document.getElementById('settings-modal');
      const profileModal = document.getElementById('profile-modal');

      if (event.target === settingsModal) {
        closeSettings();
      }
      if (event.target === profileModal) {
        closeProfile();
      }
    }
  </script>
</body>
</html>